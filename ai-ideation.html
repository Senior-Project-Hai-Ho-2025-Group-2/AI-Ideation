<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Ideation – Structured Prompt</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<style>
  body{font-family:'Inter',Arial,sans-serif;background:#f7fafc;}
  .card{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:1.5rem;}
  .card-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;}
  .card-header h2{font-size:1.5rem;font-weight:600;color:#2d3748;}
  .input{width:100%;padding:0.75rem;border:1px solid #cbd5e0;border-radius:8px;transition:border-color 0.2s;}
  .input:focus{border-color:#667eea;outline:none;}
  .select{width:100%;padding:0.75rem;border:1px solid #cbd5e0;border-radius:8px;background:#fff;}
  .btn{display:inline-flex;align-items:center;gap:0.5rem;background:#667eea;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;transition:background 0.2s;}
  .btn:hover{background:#5a67d8;}
  .spinner{margin:auto;border:4px solid #cbd5e0;border-top:4px solid #667eea;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .log{background:#e2e8f0;font-family:monospace;font-size:0.875rem;padding:0.75rem;border-radius:8px;height:140px;overflow:auto;}
  .section{margin-bottom:1.5rem;}
  .section:last-child{margin-bottom:0;}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
</style>
</head>
<body class="min-h-screen py-8 px-4 md:px-0">
<div class="max-w-4xl mx-auto">

  <!-- Header card -->
  <div class="card mb-6">
    <div class="card-header">
      <i class="fas fa-lightbulb text-2xl text-indigo-600"></i>
      <h2>AI Ideation – Structured Prompt</h2>
    </div>
    <p class="text-gray-600">Generate project ideas that match your constraints and budget.</p>
  </div>

  <!-- Main form -->
  <div class="card mb-6">
    <form id="problemForm">

      <!-- Model selection -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Model Type:</label>
        <select id="modelType" required onchange="handleModelType()" class="select">
          <option value="">-- choose --</option>
          <option value="openai">OpenAI</option>
          <option value="selfhosted">Self‑Hosted</option>
        </select>
      </div>

      <!-- OpenAI API key -->
      <div id="apiKeyField" class="section hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key:</label>
        <input type="text" id="apiKey" class="input" placeholder="sk-…" autocomplete="off" onblur="fetchModels()">
      </div>

      <!-- Self‑hosted URL -->
      <div id="urlField" class="section hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">Self‑Hosted Base URL:</label>
        <input type="text" id="modelUrl" class="input" placeholder="http://localhost:11434" autocomplete="off" onblur="fetchModels()">
      </div>

      <!-- Model dropdown -->
      <div id="modelSelectField" class="section hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Model:</label>
        <select id="modelSelect" required class="select"></select>
      </div>

      <!-- Problem statement -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Problem Statement:</label>
        <input type="text" id="problem" class="input" placeholder="Describe your problem…" required>
      </div>

      <!-- Technology check‑boxes -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Technologies:</label>
        <div class="grid-2">
          <label class="flex items-center"><input type="checkbox" id="tech-ai" class="mr-2"><span>AI/ML</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-iot" class="mr-2"><span>IoT</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-mobile" class="mr-2"><span>Mobile</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-web" class="mr-2"><span>Web</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-embedded" class="mr-2"><span>Embedded</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-robotics" class="mr-2"><span>Robotics</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-control" class="mr-2"><span>Control</span></label>
          <label class="flex items-center"><input type="checkbox" id="tech-security" class="mr-2"><span>Cybersecurity</span></label>
        </div>
      </div>

      <!-- Innovation slider -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Innovation Level (1‑10):</label>
        <input type="range" id="innovationLevel" min="1" max="10" value="5" class="innovation-slider w-full">
        <div class="flex justify-between text-xs text-gray-500 mt-1"><span>Low Risk</span><span>High Innovation</span></div>
      </div>

      <!-- Complexity -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Complexity:</label>
        <select id="complexity" class="select">
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>

      <!-- Budget -->
      <div class="section">
        <label class="block text-sm font-medium text-gray-700 mb-1">Budget (USD):</label>
        <input type="number" id="budgetInput" min="0" placeholder="e.g., 5000" class="input" required>
      </div>

      <div class="section text-right">
        <button type="submit" class="btn"><i class="fas fa-magic"></i><span>Generate Project Ideas</span></button>
      </div>

    </form>
  </div>

  <!-- Results card -->
  <div id="resultsContainer" class="card mb-6">
    <div id="spinner" class="spinner hidden"></div>
    <div id="results"></div>
  </div>

  <!-- Log card -->
  <div class="card">
    <label class="block text-sm font-medium text-gray-700 mb-1">Log</label>
    <pre id="log" class="log"></pre>
  </div>

</div>
</body>

<script>
/* ---------- Logging helpers ---------- */
function log(msg){ console.log(msg); const logEl=document.getElementById('log'); logEl.textContent+=msg+'\n'; logEl.scrollTop=logEl.scrollHeight; }
function showSpinner(show){ document.getElementById('spinner').style.display=show?'block':'none'; }

/* ---------- UI visibility ---------- */
function handleModelType(){
  const type=document.getElementById('modelType').value;
  document.getElementById('apiKeyField').classList.toggle('hidden', type!=='openai');
  document.getElementById('urlField').classList.toggle('hidden', type!=='selfhosted');
  if(type==='openai'){
    document.getElementById('modelSelect').innerHTML='<option value="gpt-3.5-turbo">gpt‑3.5‑turbo</option>';
    document.getElementById('modelSelectField').classList.remove('hidden');
  }
}

/* ---------- Fetch self‑hosted models ---------- */
async function fetchModels(){
  const url=document.getElementById('modelUrl').value.trim();
  if(!url)return;
  const urlPattern=/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/;
  if(!urlPattern.test(url)){ alert('Enter a valid URL'); return; }
  log(`Fetching models from ${url}/api/tags`);
  showSpinner(true);
  try{
    const resp=await fetch(`${url}/api/tags`);
    if(!resp.ok)throw new Error(`HTTP ${resp.status}`);
    const data=await resp.json();
    const select=document.getElementById('modelSelect');
    select.innerHTML='';
    data.models.forEach(m=>{
      const opt=document.createElement('option'); opt.value=m.name; opt.textContent=m.name; select.appendChild(opt);
    });
    document.getElementById('modelSelectField').classList.remove('hidden');
    log(`Fetched ${data.models.length} models`);
  }catch(err){ console.error(err); log(`Error fetching models: ${err.message}`); alert('Could not fetch models'); }
  finally{ showSpinner(false); }
}

/* ---------- Prompt builder (unchanged except for JSON‑only instruction) ---------- */
function buildPrompt(params){
  const innovation=document.getElementById('innovationLevel').value;
  return `
You are a senior‑design project generator. Output your responses in markdown format.

For each project include:
- title
- description
- components
- technologies
- cost
- timeline
- market
- challenges
- value

Team: 4 students, 2 semesters (8‑9 months)  
Budget: $${params.budget}  
Complexity: ${params.complexity}  
Innovation Level: ${innovation}/10  
${params.problemStatement ? `Problem: ${params.problemStatement}` : ''}  
${params.technologies.length ? `Technologies: ${params.technologies.join(', ')}` : ''}
`;
}

/* ---------- Stream‑JSON helper – extracts the "content" field from each JSON object ---------- */
async function streamJSON(reader, decoder, onContent, onDone){
  let buffer='';
  while(true){
    const {value,done}=await reader.read();
    if(done) break;
    buffer+=decoder.decode(value,{stream:true});

    /* try to peel off complete JSON objects */
    let idx=0;
    while(true){
      const start=buffer.indexOf('{',idx);
      if(start===-1){ buffer=buffer.slice(idx); break; }

      let brace=0;
      let end=start;
      for(; end<buffer.length; end++){
        if(buffer[end]==='{') brace++;
        else if(buffer[end]==='}') brace--;
        if(brace===0) break;
      }
      if(brace!==0){ // incomplete object – keep it for the next chunk
        buffer=buffer.slice(start);
        break;
      }
      const jsonStr=buffer.slice(start, end+1);
      try{
        const obj=JSON.parse(jsonStr);
        if(obj.message && typeof obj.message.content==='string'){
          onContent(obj.message.content);
        }
      }catch(e){
        /* ignore malformed pieces */
      }
      idx=end+1;
    }
  }
  onDone();
}

/* ---------- Submit handler ---------- */
document.getElementById('problemForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const type=document.getElementById('modelType').value;
  const model=document.getElementById('modelSelect').value;
  const problem=document.getElementById('problem').value.trim();
  const budget=document.getElementById('budgetInput').value.trim();
  if(!type||!model||!problem||!budget){ alert('All required fields must be filled.'); return; }

  log(`Submitting problem: "${problem}" with budget $${budget} to model "${model}" (${type})`);
  showSpinner(true);
  document.getElementById('results').innerHTML='';
  const isSelfHosted=type==='selfhosted';

  try{
    let url,headers;
    if(type==='openai'){
      const apiKey=document.getElementById('apiKey').value.trim();
      if(!apiKey){ alert('Enter your OpenAI API key.'); return; }
      url='https://api.openai.com/v1/chat/completions';
      headers={'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`};
    }else{
      const base=document.getElementById('modelUrl').value.trim();
      url=`${base}/api/chat`;
      headers={'Content-Type':'application/json'};
    }

    /* gather tech params */
    const techs=[];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>{
      const txt=cb.parentElement.textContent.trim();
      if(txt)techs.push(txt);
    });

    const params={
      problemStatement:problem,
      technologies:techs,
      budget:budget,
      complexity:document.getElementById('complexity')?document.getElementById('complexity').value:'intermediate'
    };
    const prompt=buildPrompt(params);

    const body=JSON.stringify({
      model,
      messages:[{role:'user', content:prompt}],
      temperature:0.8,
      max_tokens:2000
    });

    log(`Request body: ${body}`);
    const resp=await fetch(isSelfHosted?url:`${url}`,{
      method:'POST',
      headers:headers,
      body:isSelfHosted?body:JSON.stringify({
        ...JSON.parse(body),
        response_format:{ type:'json_object' }   // only for OpenAI v4
      })
    });

    if(!resp.ok)throw new Error(`API Error: ${resp.status} ${resp.statusText}`);

    const decoder=new TextDecoder();
    const reader=resp.body.getReader();

    /* for any provider – we only stream the content of the message */
    streamJSON(reader, decoder, chunk=>{
      document.getElementById('results').innerHTML+=chunk;
    }, ()=>{
      showSpinner(false);
    });

  }catch(err){ console.error(err); log(`Error: ${err.message}`); document.getElementById('results').innerHTML=`<p class="text-red-600">Error: ${err.message}</p>`; showSpinner(false); }
});
</script>
</html>